name: Build Firmware
on:
  push:
    branches:
      - main
  pull_request:
    types: [ opened, synchronize, reopened ]

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.make-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Run board generator and commit changes (action)
        uses: ./.github/actions/generate-boards
        with:
          commit: 'true'
        # action will run the generator and push changes if there are any.

      - name: Make matrix from Buildscripts/boards.json
        id: make-matrix
        run: |
          if [ ! -f Buildscripts/boards.json ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
            exit 0
          fi
          # ensure jq is available
          sudo apt-get update -y
          sudo apt-get install -y jq
          # Build matrix: each element contains id and arch (fallback arch if not specified)
          MATRIX=$(jq -c '[.[] | {id: .id, arch: (.arch // "esp32s3")}]' Buildscripts/boards.json)
          echo "matrix=${MATRIX}" >> $GITHUB_OUTPUT

  build:
    name: Build Firmware
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        board: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Update to latest commit
        # ensure the build job uses the branch tip that prepare may have pushed
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ -z "$BRANCH" ] || [ "$BRANCH" = "$GITHUB_REF" ]; then
            BRANCH="main"
          fi
          echo "Fetching origin/${BRANCH} and resetting workspace to it..."
          git fetch origin "${BRANCH}"
          git reset --hard "origin/${BRANCH}"

      - name: Build
        uses: ./.github/actions/build-firmware
        with:
          board_id: ${{ matrix.board.id }}
          arch: ${{ matrix.board.arch }}
