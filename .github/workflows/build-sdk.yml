name: Build SDK
on:
  push:
    branches:
      - main
      - SSOT-board-config
  pull_request:
    types: [ opened, synchronize, reopened ]

permissions: 
  contents: read

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Run board generator and commit changes (action)
        uses: ./.github/actions/generate-boards
        with:
          commit: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        # action will run the generator and push changes if there are any.

  build:
    needs: prepare
    strategy:
      matrix:
        board: [
          { id: cyd-2432s028r, arch: esp32 },
          { id: lilygo-tdeck, arch: esp32s3 },
        ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: "Build"
        uses: ./.github/actions/build-sdk
        with:
          board_id: ${{ matrix.board.id }}
          arch: ${{ matrix.board.arch }}
