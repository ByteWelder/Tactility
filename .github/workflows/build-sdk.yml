name: Build SDK
on:
  push:
    branches:
      - main
      - SSOT-board-config
  pull_request:
    types: [ opened, synchronize, reopened ]

permissions: 
  contents: read

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Run board generator
        uses: ./.github/actions/generate-boards

      - name: Check generated files are committed
        shell: bash
        run: |
          set -euo pipefail
          # Fail if any generated files are unstaged/changed/untracked
          if ! git diff --exit-code --quiet || git ls-files --others --exclude-standard | grep -q .; then
            echo "ERROR: Generated files are out-of-date. Run:"
            echo "  python3 Buildscripts/generate_boards.py"
            echo "then git add/commit the generated files and re-run the CI."
            echo
            echo "Changed files:"
            git --no-pager status --porcelain
            exit 1
          fi

  build:
    needs: prepare
    strategy:
      matrix:
        board: [
          { id: cyd-2432s028r, arch: esp32 },
          { id: lilygo-tdeck, arch: esp32s3 },
        ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: "Build"
        uses: ./.github/actions/build-sdk
        with:
          board_id: ${{ matrix.board.id }}
          arch: ${{ matrix.board.arch }}
